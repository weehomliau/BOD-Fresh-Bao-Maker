<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>B.O.D åŒ…æ ˆï¼šæé€ŸåŒ…ç‚¹å¸ˆ</title>
    
    <link rel="icon" type="image/png" href="assets/cover.png">
    <link rel="apple-touch-icon" href="assets/cover.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#b91c1c">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-10px) rotate(2deg); } }
      @keyframes steam-rise { 0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 0; } 20% { opacity: 0.5; } 100% { transform: translateY(-60px) scale(1.5) rotate(10deg); opacity: 0; } }
      @keyframes shake-hard { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
      @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
      @keyframes steam-pump { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.02); } }
      @keyframes fire-pulse { 0% { transform: scale(1); text-shadow: 0 0 2px orange; } 50% { transform: scale(1.2); text-shadow: 0 0 10px red; } 100% { transform: scale(1); text-shadow: 0 0 2px orange; } }
      @keyframes fever-bg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

      .animate-float { animation: float 6s ease-in-out infinite; }
      .animate-steam { animation: steam-rise 2.5s ease-out infinite; }
      .animate-shake-hard { animation: shake-hard 0.5s ease-in-out infinite; }
      .animate-pop { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
      .animate-pump { animation: steam-pump 1s ease-in-out infinite; }
      .animate-combo { animation: fire-pulse 0.3s ease-in-out; }
      .animate-fever-bg { background-size: 200% 200%; animation: fever-bg 1s ease infinite; }
      
      .gpu-accel { transform: translate3d(0,0,0); will-change: transform; }
      
      body { touch-action: none; overscroll-behavior: none; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
      .btn-press:active { transform: scale(0.92) !important; transition: transform 0.05s; }
    </style>
    
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.7.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
</head>
<body class="bg-neutral-900 min-h-[100dvh] flex items-center justify-center font-sans overflow-hidden fixed inset-0">
    <div id="root" class="w-full max-w-md h-[100dvh] bg-gray-100 sm:rounded-3xl shadow-2xl relative flex flex-col"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, memo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { ChefHat, Timer, Trophy, Flame, Utensils, RotateCcw, XCircle, CheckCircle, User, ArrowLeft, Crown, Globe, Sparkles, Trash2, Loader2, Zap, Clock, Volume2, VolumeX, Download, Share, PlusSquare } from 'lucide-react';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const GAME_DURATION = 90; 
        const FEVER_DURATION = 5000; 

        const firebaseConfig = {
            apiKey: "AIzaSyADgrOOUC0C1fCuFyjeggJCgAPYewz6AEA",
            authDomain: "bod-fresh-bao-maker.firebaseapp.com",
            projectId: "bod-fresh-bao-maker",
            storageBucket: "bod-fresh-bao-maker.firebasestorage.app",
            messagingSenderId: "326015657318",
            appId: "1:326015657318:web:40ad92d97a662e80f8d4a7",
            measurementId: "G-SYYFVWFLYN"
        };

        let db = null;
        let isOnline = false;

        if (firebaseConfig.apiKey && firebaseConfig.projectId) {
            try {
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app); 
                db = getFirestore(app);
                isOnline = true;
                console.log("ğŸ”¥ Firebase è¿æ¥æˆåŠŸ");
            } catch (e) {
                console.error("Firebase Init Error:", e);
            }
        }

        const getLeaderboard = async () => {
          if (isOnline && db) {
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(30));
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) { return []; }
          } else {
            const saved = localStorage.getItem('bod_leaderboard');
            return saved ? JSON.parse(saved) : [];
          }
        };

        const saveScoreToLeaderboard = async (name, score) => {
          const newEntry = { name, score, date: new Date().toISOString() };
          if (isOnline && db) {
            try {
                await addDoc(collection(db, "leaderboard"), newEntry);
                return await getLeaderboard();
            } catch (error) { return []; }
          } else {
            const current = localStorage.getItem('bod_leaderboard') ? JSON.parse(localStorage.getItem('bod_leaderboard')) : [];
            const updated = [...current, newEntry].sort((a, b) => b.score - a.score).slice(0, 30);
            localStorage.setItem('bod_leaderboard', JSON.stringify(updated));
            return updated;
          }
        };

        // --- é«˜æ€§èƒ½å›¾ç‰‡ç»„ä»¶ ---
        const SafeImage = memo(({ src, alt, fallbackIcon, className }) => {
            const [status, setStatus] = useState('loading'); 
            useEffect(() => { if(src) setStatus('loading'); }, [src]);
            if (!src) return fallbackIcon;
            return (
                <div className={`relative ${className} w-full h-full flex items-center justify-center overflow-hidden gpu-accel`}>
                    <img 
                        src={src} 
                        alt={alt} 
                        loading="eager"
                        className={`absolute inset-0 w-full h-full object-contain transition-opacity duration-500 ${status === 'loaded' ? 'opacity-100' : 'opacity-0'}`}
                        onLoad={() => setStatus('loaded')}
                        onError={() => setStatus('error')} 
                    />
                    {status === 'loading' && <div className="absolute inset-0 flex items-center justify-center bg-gray-100/50"><Loader2 className="animate-spin text-red-500" size={24} /></div>}
                    {status === 'error' && <div className="absolute inset-0 flex items-center justify-center text-gray-400 bg-gray-100/10">{fallbackIcon}</div>}
                </div>
            );
        });

        // --- ç‹¬ç«‹é£ŸææŒ‰é’® ---
        const IngredientBtn = memo(({ ing, onClick, shouldHighlight }) => {
            return (
                <button
                  onPointerDown={(e) => { e.preventDefault(); onClick(ing); }}
                  className={`flex flex-col items-center justify-center p-2 rounded-xl border transition-all duration-75 aspect-square overflow-hidden group relative btn-press
                     ${shouldHighlight ? 'scale-105 bg-white border-gray-300 shadow-md z-10' : 'bg-gray-50 border-gray-100 hover:bg-gray-100 scale-100'}
                  `}
                >
                  <div className={`w-12 h-12 flex items-center justify-center mb-1`}>
                      <SafeImage 
                        key={ing.image} 
                        src={ing.image} 
                        alt={ing.name} 
                        className="w-full h-full object-contain" 
                        fallbackIcon={<span className="text-3xl">{ing.icon}</span>}
                      />
                  </div>
                  <span className={`text-xs font-medium leading-tight text-center ${shouldHighlight ? 'font-bold text-gray-800' : 'text-gray-600'}`}>{ing.name}</span>
                </button>
            );
        });

        // --- ç‹¬ç«‹æè¤¶ç»„ä»¶ ---
        const FoldingStage = memo(({ onComplete, playSfx }) => {
            const [progress, setProgress] = useState(0);
            const isCompletedRef = useRef(false); 

            const handlePointerDown = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (isCompletedRef.current) return; 

                playSfx('pop');
                
                setProgress(prev => {
                    const next = prev + 15;
                    if (next >= 100) {
                        isCompletedRef.current = true; 
                        setTimeout(() => onComplete(), 0);
                        return 100;
                    }
                    return next;
                });
            };

            useEffect(() => {
                isCompletedRef.current = false;
                setProgress(0);
            }, []);

            return (
                <div className="flex flex-col items-center justify-center w-full h-full">
                   <div 
                     className="w-48 h-48 bg-orange-100 rounded-full border-4 border-orange-200 shadow-xl flex items-center justify-center cursor-pointer relative overflow-hidden btn-press gpu-accel"
                     onPointerDown={handlePointerDown}
                   >
                     <SafeImage 
                        src="assets/folding_bun.png"
                        alt="Raw Bun"
                        className="w-full h-full object-cover pointer-events-none" 
                        fallbackIcon={<div className="text-6xl">âšª</div>}
                     />
                     <div className="absolute inset-0 bg-black opacity-10 pointer-events-none" style={{ clipPath: `polygon(50% 50%, ${100-progress}% 0, 100% 0, 100% 100%, 0 100%, 0 0)` }}></div>
                     <div className="absolute bottom-4 text-[10px] font-bold text-orange-800 bg-white/50 px-2 rounded-full pointer-events-none">
                        {progress}%
                     </div>
                   </div>
                   <p className="mt-4 text-gray-500 font-bold animate-pulse text-sm pointer-events-none">ç–¯ç‹‚ç‚¹å‡»åŒ…å­ï¼</p>
                   <div className="w-40 h-2 bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner"><div className="h-full bg-yellow-500 transition-all duration-75" style={{ width: `${progress}%` }}></div></div>
                </div>
            );
        });

        const RECIPES = [
          { id: 'kungfu_bun', name: 'åŠŸå¤«è‚‰åŒ…', description: 'B.O.D é•‡åº—ä¹‹å®', ingredients: ['é¢å›¢', 'çŒªè‚‰ç‰‡', 'åŒ…èœ', 'èŠ±é›•é…’'], color: 'bg-orange-100', icon: <span className="text-4xl">ğŸ¥‹</span>, image: "assets/kungfu_bun.png", difficulty: 2 },
          { id: 'bbq_bun', name: 'å¾¡å“å‰çƒ§åŒ…', description: 'ç‹¬å®¶ç§˜åˆ¶é…±æ±', ingredients: ['é¢å›¢', 'ç§˜åˆ¶å‰çƒ§'], color: 'bg-red-50', icon: <span className="text-4xl">ğŸ–</span>, image: "assets/bbq_bun.png", difficulty: 1 },
          { id: 'lava_bun', name: 'å’¸è›‹æµæ²™åŒ…', description: 'çˆ†æµ†å£æ„Ÿ', ingredients: ['é¢å›¢', 'å’¸è›‹é»„æµæ²™'], color: 'bg-yellow-100', icon: <span className="text-4xl">ğŸ¥š</span>, image: "assets/lava_bun.png", difficulty: 1 },
          { id: 'mei_cai_bun', name: 'æ¢…èœåŒ…', description: 'ç»å…¸å®¢å®¶é£å‘³', ingredients: ['é¢å›¢', 'æ¢…èœ'], color: 'bg-green-50', icon: <span className="text-4xl">ğŸ¥¬</span>, image: "assets/mei_cai_bun.png", difficulty: 1 },
          { id: 'cheese_pot', name: 'é¦™é¦™èµ·å¸çª', description: 'å¹´è½»äººçš„æœ€çˆ±', ingredients: ['é¢å›¢', 'èŠå£«ç¢', 'åŸ¹æ ¹'], color: 'bg-yellow-50', icon: <span className="text-4xl">ğŸ§€</span>, image: "assets/cheese_bun.png", difficulty: 2 },
          { id: 'red_bean_bun', name: 'è±†æ²™åŒ…', description: 'ç»å…¸çº¢è±†', ingredients: ['é¢å›¢', 'å¤©æ´¥çº¢è±†'], color: 'bg-red-50', icon: <span className="text-4xl">ğŸ«˜</span>, image: "assets/red_bean_bun.png", difficulty: 1 }
        ];

        const INGREDIENTS_POOL = [
          { id: 'é¢å›¢', name: 'è€é¢é¢å›¢', icon: 'âšª', image: "assets/dough.png" },
          { id: 'ç§˜åˆ¶å‰çƒ§', name: 'ç§˜åˆ¶å‰çƒ§', icon: 'ğŸ–', image: "assets/char_siu.png" },
          { id: 'çŒªè‚‰ç‰‡', name: 'ä¸Šç­‰è‚‰ç‰‡', icon: 'ğŸ¥©', image: "assets/pork.png" },
          { id: 'åŒ…èœ', name: 'æ–°é²œåŒ…èœ', icon: 'ğŸ¥¬', image: "assets/cabbage.png" },
          { id: 'èŠ±é›•é…’', name: 'é™ˆå¹´èŠ±é›•', icon: 'ğŸ¶', image: "assets/wine.png" }, 
          { id: 'å’¸è›‹é»„æµæ²™', name: 'æµæ²™é¦…', icon: 'ğŸ¥š', image: "assets/salted_egg.png" },
          { id: 'æ¢…èœ', name: 'æ¢…èœ', icon: 'ğŸ¥˜', image: "assets/mei_cai.png" },
          { id: 'èŠå£«ç¢', name: 'èµ·å¸', icon: 'ğŸ§€', image: "assets/cheese.png" }, 
          { id: 'åŸ¹æ ¹', name: 'çƒŸç†åŸ¹æ ¹', icon: 'ğŸ¥“', image: "assets/bacon.png" },
          { id: 'å¤©æ´¥çº¢è±†', name: 'å¤©æ´¥çº¢è±†', icon: 'ğŸ«˜', image: "assets/red_bean_paste.png" },
        ];

        function BODGame() {
          const [gameState, setGameState] = useState('MENU'); 
          const [score, setScore] = useState(0);
          const [timeLeft, setTimeLeft] = useState(GAME_DURATION);
          const [currentOrder, setCurrentOrder] = useState(null);
          const [worktable, setWorktable] = useState([]); 
          const [cookingStep, setCookingStep] = useState('PREP'); 
          const [steamProgress, setSteamProgress] = useState(0); 
          const [feedback, setFeedback] = useState(null); 
          const [playerName, setPlayerName] = useState('');
          const [isScoreSaved, setIsScoreSaved] = useState(false);
          const [leaderboardData, setLeaderboardData] = useState([]);
          const [isLoadingRank, setIsLoadingRank] = useState(false);
          
          const [combo, setCombo] = useState(0); 
          const [isFever, setIsFever] = useState(false);
          const [feverClickAnim, setFeverClickAnim] = useState(null); 
          
          const [deferredPrompt, setDeferredPrompt] = useState(null);
          const [showInstallModal, setShowInstallModal] = useState(false);
          const [isIOS, setIsIOS] = useState(false);
          
          const [isMuted, setIsMuted] = useState(false);
          
          // æ ¸å¿ƒéŸ³é¢‘ç»„ä»¶
          const audioCtxRef = useRef(null); 
          const bgmElementRef = useRef(null); 
          const victoryElementRef = useRef(null); 
          // ä½¿ç”¨ AudioBuffer è€Œä¸æ˜¯ Audio å…ƒç´ æ± 
          const sfxBuffers = useRef({});

          const steamLockedRef = useRef(false);
          const timerRef = useRef(null);
          const steamTimerRef = useRef(null);

          // --- åˆå§‹åŒ–éŸ³é¢‘ (Web Audio API) ---
          useEffect(() => {
              const isDeviceIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
              setIsIOS(isDeviceIOS);

              const handleBeforeInstallPrompt = (e) => {
                  e.preventDefault();
                  setDeferredPrompt(e);
              };
              window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

              // 1. åˆ›å»º AudioContext (åªåˆ›å»ºä¸€æ¬¡)
              const AudioContext = window.AudioContext || window.webkitAudioContext;
              if (AudioContext) {
                  audioCtxRef.current = new AudioContext();
              }

              // 2. åŠ è½½å¹¶è§£ç éŸ³æ•ˆ (è¿™æ˜¯å…³é”®ï¼šè§£ç åå°±åœ¨å†…å­˜é‡Œï¼Œæ’­æ”¾é›¶å»¶è¿Ÿ)
              const loadSound = async (url, name) => {
                  if (!audioCtxRef.current) return;
                  try {
                      const response = await fetch(url);
                      const arrayBuffer = await response.arrayBuffer();
                      const audioBuffer = await audioCtxRef.current.decodeAudioData(arrayBuffer);
                      sfxBuffers.current[name] = audioBuffer;
                  } catch (error) {
                      console.warn(`Failed to load sound: ${url}`, error);
                  }
              };

              if (audioCtxRef.current) {
                  loadSound('assets/pop.mp3', 'pop');
                  loadSound('assets/win.mp3', 'win');
                  loadSound('assets/lose.mp3', 'lose');
              }

              // BGM ä¾ç„¶ç”¨ HTML5 Audio æ ‡ç­¾ (æ–¹ä¾¿å¾ªç¯å’Œæµå¼åŠ è½½)
              bgmElementRef.current = new Audio('assets/bgm.mp3');
              bgmElementRef.current.loop = true;
              bgmElementRef.current.volume = 0.3;

              victoryElementRef.current = new Audio('assets/victory.mp3');
              victoryElementRef.current.loop = true;
              victoryElementRef.current.volume = 0.4;

              return () => {
                  window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                  if (audioCtxRef.current) audioCtxRef.current.close();
                  if (bgmElementRef.current) { bgmElementRef.current.pause(); bgmElementRef.current = null; }
                  if (victoryElementRef.current) { victoryElementRef.current.pause(); victoryElementRef.current = null; }
              };
          }, []);

          const handleInstallClick = () => {
              if (deferredPrompt) {
                  deferredPrompt.prompt();
                  deferredPrompt.userChoice.then((choiceResult) => {
                      setDeferredPrompt(null);
                      setShowInstallModal(false);
                  });
              } else {
                  setShowInstallModal(true);
              }
          };

          // --- æ’­æ”¾éŸ³æ•ˆ (Web Audio API: é›¶å»¶è¿Ÿã€é«˜å¹¶å‘) ---
          const playSfx = useCallback((name) => {
              if (isMuted || !audioCtxRef.current || !sfxBuffers.current[name]) return;
              
              // iOS éœ€è¦ç”¨æˆ·äº¤äº’å resume
              if (audioCtxRef.current.state === 'suspended') {
                  audioCtxRef.current.resume();
              }

              // åˆ›å»ºå‘å°„æº -> è¿æ¥éŸ³é‡ -> è¾“å‡º
              const source = audioCtxRef.current.createBufferSource();
              source.buffer = sfxBuffers.current[name];
              
              const gainNode = audioCtxRef.current.createGain();
              gainNode.gain.value = 1.0; // æœ€å¤§éŸ³é‡
              
              source.connect(gainNode);
              gainNode.connect(audioCtxRef.current.destination);
              
              source.start(0); // ç«‹å³æ’­æ”¾
          }, [isMuted]);

          // --- BGM æ§åˆ¶é€»è¾‘ ---
          useEffect(() => {
              if (!bgmElementRef.current || !victoryElementRef.current) return;

              if (isMuted) {
                  bgmElementRef.current.pause();
                  victoryElementRef.current.pause();
              } else {
                  if (gameState === 'PLAYING') {
                      // å°è¯•å”¤é†’ AudioContext (é’ˆå¯¹ iOS)
                      if(audioCtxRef.current && audioCtxRef.current.state === 'suspended') {
                          audioCtxRef.current.resume();
                      }
                      
                      victoryElementRef.current.pause();
                      victoryElementRef.current.currentTime = 0;
                      
                      const playPromise = bgmElementRef.current.play();
                      if (playPromise !== undefined) playPromise.catch(() => {});
                      bgmElementRef.current.playbackRate = isFever ? 1.5 : 1.0;

                  } else if (gameState === 'GAMEOVER') {
                      bgmElementRef.current.pause();
                      bgmElementRef.current.currentTime = 0;
                      const playPromise = victoryElementRef.current.play();
                      if (playPromise !== undefined) playPromise.catch(() => {});
                  } else {
                      bgmElementRef.current.pause();
                      bgmElementRef.current.currentTime = 0;
                      victoryElementRef.current.pause();
                      victoryElementRef.current.currentTime = 0;
                  }
              }
          }, [gameState, isMuted, isFever]);

          useEffect(() => {
            if (gameState === 'PLAYING' && !isFever) {
              timerRef.current = setInterval(() => {
                setTimeLeft((prev) => {
                  if (prev <= 1) {
                    endGame();
                    return 0;
                  }
                  return prev - 1;
                });
              }, 1000);
            }
            return () => clearInterval(timerRef.current);
          }, [gameState, isFever]);

          useEffect(() => {
            if (gameState === 'LEADERBOARD') {
                setIsLoadingRank(true);
                getLeaderboard().then(data => {
                    setLeaderboardData(data);
                    setIsLoadingRank(false);
                });
            }
          }, [gameState]);

          const generateNewOrder = () => {
            const randomRecipe = RECIPES[Math.floor(Math.random() * RECIPES.length)];
            setCurrentOrder(randomRecipe);
            setWorktable([]);
            setCookingStep('PREP');
            setSteamProgress(0);
          };

          const startFeverMode = () => {
             setIsFever(true);
             showFeedback('ğŸ”¥ FEVER TIME! æ—¶é—´æš‚åœ!', 'success');
             setTimeout(() => {
                 setIsFever(false);
                 setTimeLeft(prev => prev + 5); 
                 showFeedback('â±ï¸ æ—¶é—´ +5ç§’!', 'success');
                 generateNewOrder(); 
             }, FEVER_DURATION);
          };

          const handleFeverClick = (side, e) => {
              if(e) { e.preventDefault(); e.stopPropagation(); }
              playSfx('win'); 
              setScore(prev => prev + 1);
              setFeverClickAnim(side);
              setTimeout(() => setFeverClickAnim(null), 50); 
          };

          const startGame = () => {
            setScore(0);
            setCombo(0); 
            setIsFever(false);
            setTimeLeft(GAME_DURATION);
            generateNewOrder();
            setGameState('PLAYING');
            setFeedback(null);
            setIsScoreSaved(false);
            setPlayerName('');
            // æ¸¸æˆå¼€å§‹æ—¶å†æ¬¡å°è¯•å”¤é†’éŸ³é¢‘å¼•æ“
            if (audioCtxRef.current && audioCtxRef.current.state === 'suspended') {
                audioCtxRef.current.resume();
            }
          };

          const endGame = () => {
            clearInterval(timerRef.current);
            clearInterval(steamTimerRef.current);
            setIsFever(false);
            setGameState('GAMEOVER');
          };

          const handleSaveScore = async () => {
            if (!playerName.trim()) {
              showFeedback('âœï¸ è¯·è¾“å…¥åå­—ï¼', 'error');
              return;
            }
            setIsLoadingRank(true);
            await saveScoreToLeaderboard(playerName, score);
            setIsScoreSaved(true);
            showFeedback('ğŸ’¾ æˆç»©å·²ä¿å­˜ï¼', 'success');
            setIsLoadingRank(false);
            setTimeout(() => setGameState('LEADERBOARD'), 1000);
          };

          const handleResetWorktable = () => {
             if (worktable.length === 0) return;
             playSfx('lose'); 
             setWorktable([]);
             setCombo(0);
             showFeedback('è¿å‡»ä¸­æ–­!', 'error');
          };

          const handleIngredientClick = (ing) => {
            if (cookingStep !== 'PREP' || isFever) return;

            if (!currentOrder.ingredients.includes(ing.id)) {
              playSfx('lose'); 
              showFeedback('âŒ é£Ÿæé”™è¯¯ï¼è¿å‡»ä¸­æ–­ï¼', 'error');
              setCombo(0); 
              setWorktable([]); 
              return;
            }

            if (worktable.length === 0 && ing.id !== 'é¢å›¢') {
              playSfx('lose');
              showFeedback('âš ï¸ è¯·å…ˆæ‹¿é¢å›¢ï¼', 'warning');
              return;
            }
            
            if (ing.id === 'é¢å›¢' && worktable.includes('é¢å›¢')) {
                showFeedback('âš ï¸ å·²ç»æœ‰é¢å›¢äº†ï¼', 'warning');
                return;
            }
            
            if (ing.id !== 'é¢å›¢' && worktable.includes(ing.id)) {
                 showFeedback('âš ï¸ å·²ç»åŠ è¿‡äº†ï¼', 'warning');
                 return;
            }

            playSfx('pop'); 
            const newWorktable = [...worktable, ing.id];
            setWorktable(newWorktable);

            const needed = [...currentOrder.ingredients].sort();
            const current = [...newWorktable].sort();
            
            if (JSON.stringify(needed) === JSON.stringify(current)) {
              showFeedback('âœ… é£Ÿæå¤‡é½ï¼å¼€å§‹æè¤¶ï¼', 'success');
              setTimeout(() => setCookingStep('FOLDING'), 150);
            }
          };

          const handleFoldComplete = useCallback(() => {
            setCookingStep('STEAMING');
            showFeedback('ğŸ¥Ÿ é€ å‹å®Œç¾ï¼æ”¾å…¥è’¸ç¬¼ï¼', 'success');
            startSteaming();
          }, []);

          const startSteaming = () => {
            if (steamTimerRef.current) clearInterval(steamTimerRef.current);
            steamLockedRef.current = false;
            let progress = 0;
            const difficultySpeed = 2 + Math.floor(score / 500) * 0.3;
            steamTimerRef.current = setInterval(() => {
              progress += difficultySpeed; 
              setSteamProgress(progress);
              if (progress > 120) { 
                clearInterval(steamTimerRef.current);
                handleSteamResult(false, 'ğŸ”¥ è’¸ç³Šäº†ï¼å¤ªä¹…äº†ï¼');
              }
            }, 50);
          };

          const handleStopSteam = () => {
            if (steamLockedRef.current) return;
            steamLockedRef.current = true;
            clearInterval(steamTimerRef.current);
            
            if (steamProgress >= 80 && steamProgress <= 100) {
              handleSteamResult(true, 'âœ¨ å®Œç¾å‡ºç‚‰ï¼');
            } else if (steamProgress < 80) {
              handleSteamResult(false, 'â„ï¸ è¿˜æ²¡ç†Ÿï¼é‡Œé¢æ˜¯ç”Ÿçš„ï¼');
            } else {
              handleSteamResult(false, 'ğŸ”¥ è’¸è¿‡å¤´äº†ï¼çš®è€äº†ï¼');
            }
          };

          const handleSteamResult = (success, msg) => {
            if (success) {
              playSfx('win'); 
              const newCombo = combo + 1;
              setCombo(newCombo);

              const points = 100 + Math.floor(timeLeft / 10);
              const comboBonus = Math.floor(points * (newCombo * 0.1));
              const totalPoints = points + comboBonus;

              const newScore = score + totalPoints;
              setScore(newScore); 
              showFeedback(`${msg} +${totalPoints} (è¿å‡» x${newCombo})`, 'success');
              
              if (newCombo > 0 && newCombo % 5 === 0) {
                  setTimeout(startFeverMode, 500); 
              } else {
                  setTimeout(generateNewOrder, 600);
              }
            } else {
              playSfx('lose'); 
              setCombo(0); 
              showFeedback(msg + ' è¿å‡»ä¸­æ–­', 'error');
              setTimeLeft(prev => Math.max(0, prev - 5));
              
              if (steamTimerRef.current) clearInterval(steamTimerRef.current);

              setTimeout(() => {
                setWorktable([]);
                setCookingStep('PREP');
                setSteamProgress(0);
              }, 1000);
            }
          };

          const showFeedback = (msg, type) => {
            setFeedback({ msg, type });
            setTimeout(() => setFeedback(null), 1500);
          };

          const getFeedbackColor = () => {
            if (!feedback) return '';
            if (feedback.type === 'error') return 'bg-red-500';
            if (feedback.type === 'success') return 'bg-green-500';
            return 'bg-yellow-500';
          };

          const getStepInstruction = () => {
              if (isFever) return "ğŸ”¥ ç–¯ç‹‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®! ğŸ”¥";
              if (!currentOrder) return '';
              if (worktable.length === 0) return "å…ˆå–é¢å›¢ âšª";
              const added = worktable;
              const missing = currentOrder.ingredients.filter(ing => !added.includes(ing));
              if (missing.length > 0) return `è¿˜éœ€ï¼š${missing.join(' + ')}`;
              return "å‡†å¤‡æè¤¶ï¼";
          };

          // --- ç•Œé¢æ¸²æŸ“ ---
          // (æ­¤éƒ¨åˆ†ä¸å‰ä¸€ç‰ˆç›¸åŒï¼Œä¸ºç¡®ä¿å®Œæ•´æ€§å†æ¬¡æä¾›)
          if (gameState === 'MENU') {
            return (
              <div className="h-full w-full flex flex-col items-center justify-between p-6 font-sans relative overflow-hidden bg-orange-50">
                <div className="absolute inset-0 opacity-10 pointer-events-none" style={{backgroundImage: 'radial-gradient(#fbbf24 2px, transparent 2px)', backgroundSize: '30px 30px'}}></div>
                <div className="flex-1 flex flex-col items-center justify-center w-full max-w-sm z-10 animate-pop min-h-0">
                    <div className="w-full flex-1 min-h-0 mb-6 relative flex items-center justify-center">
                        <SafeImage 
                            src="assets/cover.png" 
                            alt="B.O.D Game Cover" 
                            className="max-h-full max-w-full object-contain rounded-2xl drop-shadow-2xl" 
                            fallbackIcon={
                                <div className="w-full h-full aspect-[4/5] max-h-full flex flex-col items-center justify-center text-center p-4 bg-white/90 backdrop-blur rounded-3xl shadow-xl border-4 border-orange-200">
                                    <ChefHat size={80} className="text-red-600 mx-auto mb-4 shrink-0" />
                                    <h1 className="text-3xl font-black text-red-800 shrink-0">B.O.D åŒ…æ ˆ</h1>
                                    <p className="text-orange-600 font-bold mt-2 shrink-0">æé€ŸåŒ…ç‚¹å¸ˆ</p>
                                    <p className="text-xs text-gray-400 mt-2">å›¾ç‰‡æœªåŠ è½½: assets/cover.png</p>
                                </div>
                            }
                        />
                    </div>
                    <div className="w-full space-y-4 px-4 shrink-0">
                        <button onClick={startGame} className="w-full bg-red-600 hover:bg-red-500 text-white font-black py-4 px-6 rounded-2xl text-xl shadow-[0_6px_0_#991b1b] active:shadow-none active:translate-y-1.5 transition-all flex items-center justify-center gap-3 border-2 border-red-700">
                          <Utensils className="animate-bounce" size={24} /> å¼€å§‹åˆ¶ä½œ
                        </button>
                        <button onClick={() => setGameState('LEADERBOARD')} className="w-full bg-yellow-400 hover:bg-yellow-300 text-yellow-900 font-bold py-3 px-6 rounded-2xl text-lg shadow-[0_6px_0_#ca8a04] active:shadow-none active:translate-y-1.5 transition-all flex items-center justify-center gap-2 border-2 border-yellow-500">
                          <Trophy size={20} /> å¤§å¸ˆæ’è¡Œæ¦œ
                        </button>
                        <button onClick={handleInstallClick} className="w-full bg-white/80 hover:bg-white text-neutral-800 font-bold py-3 px-6 rounded-2xl text-lg shadow-[0_6px_0_#d4d4d4] active:shadow-none active:translate-y-1.5 transition-all flex items-center justify-center gap-2 border-2 border-gray-300">
                            <Download size={20} /> æ·»åŠ åˆ°ä¸»å±å¹•
                        </button>
                    </div>
                </div>
                <div className="text-orange-900/30 text-[10px] font-black tracking-widest mt-4 z-10 shrink-0 flex flex-col items-center gap-0.5">
                    <span>MADE FOR B.O.D GAMES</span>
                    <span>By Weehom Liau â€¢ V0.19 (WebAudioæµç•…ç‰ˆ)</span>
                </div>
                {showInstallModal && (<div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in" onClick={() => setShowInstallModal(false)}><div className="bg-white rounded-3xl p-6 max-w-xs w-full relative shadow-2xl transform transition-all scale-100" onClick={e => e.stopPropagation()}><button onClick={() => setShowInstallModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><XCircle size={24} /></button><h3 className="text-xl font-black text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><Download className="text-red-600" size={24}/> å®‰è£…æ¸¸æˆ</h3>{isIOS ? (<div className="space-y-4 text-gray-600"><p className="font-bold text-black">ğŸ“± åœ¨ iPhone/iPad ä¸Šï¼š</p><ol className="list-decimal list-inside space-y-3 text-sm"><li className="flex items-start gap-2"><span className="mt-0.5">ç‚¹å‡»æµè§ˆå™¨åº•éƒ¨çš„</span><span className="inline-flex items-center justify-center bg-gray-100 p-1 rounded border"><Share size={14}/></span><span>åˆ†äº«æŒ‰é’®</span></li><li className="flex items-start gap-2"><span className="mt-0.5">å‘ä¸‹æ»‘åŠ¨ï¼Œé€‰æ‹©</span><span className="inline-flex items-center gap-1 font-bold text-black bg-gray-100 px-2 py-0.5 rounded border"><PlusSquare size={14}/> æ·»åŠ åˆ°ä¸»å±å¹•</span></li></ol></div>) : (<div className="space-y-4 text-gray-600"><p className="font-bold text-black">ğŸ“± åœ¨ Android æµè§ˆå™¨ä¸Šï¼š</p><ol className="list-decimal list-inside space-y-2 text-sm"><li>ç‚¹å‡»å³ä¸Šè§’çš„èœå•å›¾æ ‡ (â‹®)</li><li>é€‰æ‹© <strong>å®‰è£…åº”ç”¨</strong> æˆ– <strong>æ·»åŠ åˆ°ä¸»å±å¹•</strong></li></ol></div>)}<button onClick={() => setShowInstallModal(false)} className="w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-colors shadow-lg">çŸ¥é“äº†</button></div></div>)}
              </div>
            );
          }
          
          // (çœç•¥å…¶ä»–çŠ¶æ€æ¸²æŸ“ï¼Œä¿æŒä¸å˜)
          // ... LEADERBOARD, GAMEOVER ...
          if (gameState === 'LEADERBOARD') {
             // è¯·å¤åˆ¶ä¹‹å‰ç‰ˆæœ¬çš„ LEADERBOARD ä»£ç 
             return (
              <div className="h-full w-full flex flex-col items-center p-4 bg-neutral-900 text-white overflow-hidden">
                 <div className="w-full max-w-md mt-4 animate-pop flex flex-col h-full">
                   <div className="flex items-center justify-between mb-4 shrink-0">
                      <button onClick={() => setGameState('MENU')} className="bg-neutral-800 p-2 rounded-full hover:bg-neutral-700 transition-colors"><ArrowLeft size={20} /></button>
                      <h2 className="text-xl font-bold text-yellow-400 flex items-center gap-2"><Trophy className="text-yellow-400" size={20} /> åŒ…ç‚¹å¤§å¸ˆæ¦œ</h2>
                      <div className="w-9"></div>
                   </div>
                   
                   <div className="text-center mb-2 text-[10px] text-gray-400 shrink-0">
                     {isOnline ? <span className="text-green-400 flex items-center justify-center gap-1"><Globe size={10}/> å…¨çƒè”ç½‘æ¨¡å¼</span> : <span className="text-gray-500">ç¦»çº¿æ¨¡å¼ (å¡«å…¥ Key å¼€å¯è”ç½‘)</span>}
                   </div>

                   <div className="bg-white text-neutral-900 rounded-xl shadow-xl overflow-hidden flex-1 overflow-y-auto">
                      <div className="bg-red-600 p-3 text-white font-bold grid grid-cols-12 text-xs text-center sticky top-0 z-10">
                        <div className="col-span-2">æ’å</div>
                        <div className="col-span-6 text-left pl-4">åŒ…ç‚¹å¸ˆ</div>
                        <div className="col-span-4">åˆ†æ•°</div>
                      </div>
                      
                      {isLoadingRank ? (
                          <div className="p-8 text-center text-gray-500 flex flex-col items-center">
                            <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600 mb-2"></div>
                            è¯»å–ä¸­...
                          </div>
                      ) : leaderboardData.length === 0 ? (
                        <div className="p-8 text-center text-gray-400 text-sm">
                          æš‚æ— è®°å½•ï¼Œå¿«å»æŒ‘æˆ˜å§ï¼
                        </div>
                      ) : (
                        <div>
                          {leaderboardData.map((entry, index) => (
                            <div key={index} className={`grid grid-cols-12 items-center p-3 border-b text-center text-sm ${index < 3 ? 'bg-yellow-50' : ''}`}>
                              <div className="col-span-2 font-bold flex justify-center">
                                {index === 0 && <Crown size={16} className="text-yellow-500 animate-bounce" fill="currentColor" />}
                                {index === 1 && <Crown size={16} className="text-gray-400" fill="currentColor" />}
                                {index === 2 && <Crown size={16} className="text-orange-400" fill="currentColor" />}
                                {index > 2 && <span className="text-gray-500 text-xs">#{index + 1}</span>}
                              </div>
                              <div className="col-span-6 text-left pl-4 font-bold text-gray-800 truncate">
                                {entry.name}
                              </div>
                              <div className="col-span-4 font-mono font-bold text-red-600">
                                {entry.score}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                   </div>
                 </div>
              </div>
            );
          }

          if (gameState === 'GAMEOVER') {
             return (
              <div className="h-full w-full flex flex-col items-center justify-center p-4 bg-neutral-900 text-white">
                <div className="bg-white text-neutral-900 p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center border-t-8 border-red-600 animate-pop">
                  <div className="relative inline-block">
                      <Trophy size={48} className="mx-auto text-yellow-500 mb-2" />
                      {score > 500 && <Sparkles className="absolute -top-2 -right-4 text-yellow-400 animate-pulse" />}
                  </div>
                  <h2 className="text-2xl font-bold mb-1">è¥ä¸šç»“æŸ</h2>
                  <p className="text-gray-500 mb-4 text-sm">æœ¬æ¬¡å¾—åˆ†</p>
                  
                  <div className="text-5xl font-black text-red-600 mb-2 font-mono">
                    {score}
                  </div>
                  
                  {combo > 1 && (
                      <div className="text-orange-500 font-bold mb-4 flex items-center justify-center gap-1 animate-combo">
                          <Flame size={16} /> æœ€å¤§è¿å‡»: {combo}
                      </div>
                  )}

                  {!isScoreSaved ? (
                    <div className="mb-6">
                       <p className="text-xs text-gray-500 mb-2">è¾“å…¥åå­—ä¿å­˜åˆ°æ’è¡Œæ¦œ</p>
                       <div className="flex gap-2">
                         <div className="relative flex-1">
                           <User className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={16} />
                           <input 
                              type="text" 
                              value={playerName}
                              onChange={(e) => setPlayerName(e.target.value)}
                              placeholder="æ‚¨çš„åå­—"
                              className="w-full pl-9 pr-3 py-2 border-2 border-gray-200 rounded-xl focus:border-red-500 outline-none font-bold text-sm transition-all focus:ring-2 focus:ring-red-200"
                              maxLength={10}
                           />
                         </div>
                         <button 
                            onClick={handleSaveScore}
                            disabled={isLoadingRank}
                            className={`bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-xl flex items-center transition-all active:scale-95 ${isLoadingRank ? 'opacity-50 cursor-not-allowed' : ''}`}
                         >
                            {isLoadingRank ? '...' : 'ä¿å­˜'}
                         </button>
                       </div>
                    </div>
                  ) : (
                    <div className="mb-8 p-3 bg-green-100 text-green-700 rounded-xl font-bold flex items-center justify-center gap-2 animate-in fade-in">
                      <CheckCircle size={20} /> æˆç»©å·²ä¸Šä¼ 
                    </div>
                  )}

                  <div className="grid grid-cols-2 gap-3">
                    <button 
                      onClick={() => setGameState('LEADERBOARD')}
                      className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95"
                    >
                      <Trophy size={18}/> æ’è¡Œæ¦œ
                    </button>
                    <button 
                      onClick={startGame}
                      className="bg-yellow-500 hover:bg-yellow-400 text-red-900 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95"
                    >
                      <RotateCcw size={18}/> å†ç©ä¸€æ¬¡
                    </button>
                  </div>
                  
                  <button 
                    onClick={() => setGameState('MENU')}
                    className="w-full mt-3 text-gray-400 hover:text-gray-600 text-sm font-medium py-2 transition-colors"
                  >
                    è¿”å›ä¸»èœå•
                  </button>
                </div>
              </div>
            );
          }

          if (!currentOrder && gameState === 'PLAYING') {
              return <div className="h-full flex items-center justify-center bg-gray-100">å‡†å¤‡ä¸­...</div>;
          }

          return (
            <div className={`h-full w-full flex flex-col font-sans overflow-hidden ${isFever ? 'animate-fever-bg bg-gradient-to-br from-red-600 via-yellow-500 to-red-600' : ''}`}>
              <div className={`text-white px-3 py-1 flex flex-col shadow-md z-10 transition-colors duration-500 shrink-0 ${isFever ? 'bg-transparent' : (timeLeft < 10 ? 'bg-red-800 animate-shake-hard' : 'bg-red-700')}`}>
                <div className="flex justify-between items-center h-8">
                    <div className="flex items-center gap-2 font-bold text-base">
                        <button onClick={() => setIsMuted(!isMuted)} className="p-1 rounded-full hover:bg-white/20 transition-colors">{isMuted ? <VolumeX size={18} /> : <Volume2 size={18} />}</button>
                        <div className={`p-0.5 rounded-lg transition-colors ${isFever ? 'bg-white/20' : (timeLeft < 10 ? 'bg-red-900' : 'bg-red-800')}`}><Timer size={16}/></div>
                        <span className={`${timeLeft < 10 ? 'text-yellow-300 scale-110 font-black' : ''} transition-all flex items-center gap-1`}>
                            {isFever ? <span className="animate-pulse"><Clock size={14}/> PAUSED</span> : `${timeLeft}s`}
                        </span>
                    </div>
                    
                    {isFever ? (
                         <div className="font-black text-xl text-yellow-200 animate-pulse flex items-center gap-1">
                             <Zap className="fill-yellow-200" size={20} /> FEVER MODE!
                         </div>
                    ) : (
                         <div className="flex items-center gap-4">
                             {combo > 1 && (
                                 <div className="font-bold text-yellow-300 flex items-center gap-1 animate-combo text-sm">
                                     <Flame size={14} className="fill-yellow-300"/> {combo}
                                 </div>
                             )}
                             <div className="font-black text-lg text-yellow-400 flex items-center gap-1">
                                 {score}
                             </div>
                         </div>
                    )}
                </div>
                <div className="w-full h-1 bg-black/20 rounded-full overflow-hidden">
                    <div
                        className={`h-full transition-all duration-1000 ease-linear ${isFever ? 'bg-white' : (timeLeft < 10 ? 'bg-yellow-400' : 'bg-yellow-300')}`}
                        style={{ width: `${(timeLeft / GAME_DURATION) * 100}%` }}
                    ></div>
                </div>
              </div>

              {isFever ? (
                  <div className="flex-1 flex flex-col items-center justify-center p-4 gap-6 animate-pop gpu-accel">
                      <div className="text-white/90 text-center text-sm font-bold tracking-widest mb-2">ç–¯ç‹‚äº¤æ›¿ç‚¹å‡»ï¼+1åˆ†</div>
                      <div className="flex gap-4 w-full h-64">
                          <button 
                             onPointerDown={(e) => handleFeverClick('left', e)}
                             className={`flex-1 bg-white rounded-3xl shadow-xl border-b-8 border-gray-200 active:border-b-0 active:translate-y-2 transition-transform duration-75 flex flex-col items-center justify-center gap-2 group btn-press active:scale-90`}
                          >
                             <span className="text-6xl group-active:scale-125 transition-transform">ğŸ¥Ÿ</span>
                             <span className="text-2xl font-black text-orange-600">æåŒ…</span>
                          </button>
                          <button 
                             onPointerDown={(e) => handleFeverClick('right', e)}
                             className={`flex-1 bg-white rounded-3xl shadow-xl border-b-8 border-gray-200 active:border-b-0 active:translate-y-2 transition-transform duration-75 flex flex-col items-center justify-center gap-2 group btn-press active:scale-90`}
                          >
                             <span className="text-6xl group-active:scale-125 transition-transform">â™¨ï¸</span>
                             <span className="text-2xl font-black text-red-600">è’¸åŒ…</span>
                          </button>
                      </div>
                      <div className="text-4xl font-black text-yellow-300 drop-shadow-lg animate-bounce">
                          SCORE: {score}
                      </div>
                  </div>
              ) : (
                  <>
                      {/* ... æ­£å¸¸çš„è®¢å•æ˜¾ç¤ºåŒº å’Œ æ“ä½œåŒº (ä¿æŒä¸å˜) ... */}
                      {/* ... (è¯·ç›´æ¥å¤åˆ¶ä¸Šé¢çš„ NORMAL MODE å¸ƒå±€ä»£ç ï¼Œè¿™é‡Œä¸ºäº†å®Œæ•´æ€§æˆ‘è¿˜æ˜¯å…¨éƒ¨å†™å‡ºæ¥) ... */}
                      
                      <div className="bg-white p-4 border-b border-gray-200 relative z-0 shadow-sm shrink-0">
                        <div className="flex items-center gap-4">
                          <div className="w-28 h-28 min-w-[7rem] rounded-xl flex items-center justify-center text-5xl shadow-inner border border-orange-200 overflow-hidden relative group bg-orange-100">
                            <SafeImage src={currentOrder.image} alt={currentOrder.name} className="w-full h-full object-contain transition-transform group-hover:scale-110 drop-shadow-xl" fallbackIcon={currentOrder.icon} />
                          </div>
                          <div className="flex-1 min-w-0"> 
                            <div className="flex justify-between items-center mb-1">
                                <span className="text-xs font-bold text-red-600 uppercase tracking-wider">è®¢å• Order</span>
                            </div>
                            <h3 className="text-2xl font-black text-gray-800 mb-2 truncate leading-tight">{currentOrder.name}</h3>
                            
                            <div className="flex flex-wrap gap-1.5 pl-1">
                              {currentOrder.ingredients.map((ingName, idx) => {
                                 const isCollected = worktable.includes(ingName);
                                 const ingData = INGREDIENTS_POOL.find(p => p.id === ingName);
                                 return (
                                    <div key={idx} className={`relative flex items-center gap-1.5 px-2 py-1 rounded border-2 transition-all ${isCollected ? 'bg-green-100 border-green-500 text-green-800 scale-105' : 'bg-gray-50 border-gray-300 border-dashed text-gray-400'}`}>
                                       <span className="text-sm">{ingData?.icon}</span>
                                       <span className="text-xs font-bold">{ingName}</span>
                                       {isCollected && <CheckCircle size={10} className="absolute -top-1.5 -right-1.5 text-green-500 rounded-full" />}
                                    </div>
                                 );
                              })}
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className="flex-1 bg-neutral-100 relative overflow-y-auto flex flex-col">
                        
                        {feedback && (
                          <div className={`absolute top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-lg text-white font-bold flex items-center gap-2 animate-bounce ${getFeedbackColor()}`}>
                            {feedback.type === 'success' ? <CheckCircle size={20}/> : <XCircle size={20}/>}
                            {feedback.msg}
                          </div>
                        )}

                        <div className="flex-1 flex flex-col items-center justify-center p-2 transition-all perspective-[1000px] h-full min-h-[300px]">
                          
                          {cookingStep === 'PREP' && (
                            <div className="relative w-full flex flex-col items-center justify-evenly h-full">
                                <div className="relative">
                                    <div className="relative w-40 h-40 bg-white rounded-full border-4 border-gray-200 shadow-xl flex items-center justify-center animate-pop shrink-0 gpu-accel">
                                        {worktable.includes('é¢å›¢') && <div className="absolute w-32 h-32 bg-orange-50 rounded-full border border-orange-100 shadow-inner animate-pop"></div>}
                                        {worktable.slice(1).map((ing, i) => {
                                            const ingredient = INGREDIENTS_POOL.find(p => p.id === ing);
                                            return (
                                                <div key={i} className="absolute text-3xl animate-pop flex items-center justify-center" style={{ transform: `translate(${Math.random()*20-10}px, ${Math.random()*20-10}px)` }}>
                                                    <SafeImage 
                                                        src={ingredient.image} 
                                                        alt={ingredient.name} 
                                                        className="w-8 h-8 object-contain drop-shadow-md" 
                                                        fallbackIcon={<span className="text-xl">{ingredient.icon}</span>}
                                                    />
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    {worktable.length > 0 && (
                                        <button 
                                            onClick={handleResetWorktable}
                                            className="absolute -right-4 -top-2 bg-red-100 hover:bg-red-200 text-red-600 p-2 rounded-full border-2 border-red-200 shadow-md transition-all active:scale-90"
                                            title="æ¸…ç©ºå·¥ä½œå°"
                                        >
                                            <Trash2 size={16} />
                                        </button>
                                    )}
                                </div>
                            </div>
                          )}

                          {cookingStep === 'FOLDING' && <FoldingStage onComplete={handleFoldComplete} playSfx={playSfx} />}

                          {cookingStep === 'STEAMING' && (
                            <div className="flex flex-col items-center w-full justify-center h-full">
                               <div className="relative w-64 h-64 flex items-center justify-center">
                                  <div className="absolute -top-10 left-1/2 transform -translate-x-1/2 pointer-events-none z-10 w-full flex justify-center">
                                         <div className="text-5xl opacity-0 animate-steam absolute" style={{animationDelay: '0s'}}>â˜ï¸</div>
                                         <div className="text-4xl opacity-0 animate-steam absolute -left-8 top-4" style={{animationDelay: '0.8s'}}>â˜ï¸</div>
                                         <div className="text-4xl opacity-0 animate-steam absolute left-8 top-4" style={{animationDelay: '1.6s'}}>â˜ï¸</div>
                                  </div>
                                  <div className="w-full h-full relative animate-pump gpu-accel">
                                     <SafeImage 
                                        src="./assets/steamer.png" 
                                        alt="Steamer" 
                                        className="w-full h-full object-contain drop-shadow-xl" 
                                        fallbackIcon={
                                            <div className="w-48 h-40 bg-gradient-to-b from-orange-100 to-orange-300 rounded-[20px] border-b-8 border-orange-400 relative flex items-center justify-center">
                                                <div className="absolute -top-8 left-0 w-full h-16 bg-orange-200 rounded-[50%] border-4 border-orange-300 shadow-inner flex items-center justify-center">
                                                    <span className="text-6xl">â™¨ï¸</span>
                                                </div>
                                            </div>
                                        } 
                                     />
                                  </div>
                                  <div className="absolute right-2 bottom-4 w-6 h-40 bg-gray-200 rounded-full border-2 border-gray-300 shadow-xl overflow-hidden backdrop-blur-sm bg-opacity-90 z-20">
                                        <div className="absolute right-0 top-[20%] w-full h-0.5 bg-green-500 z-20 shadow-[0_0_4px_rgba(34,197,94,0.8)]"></div>
                                        <div className="absolute right-0 top-[0%] w-full h-0.5 bg-red-500 z-20"></div>
                                        <div className="absolute bottom-0 w-full bg-gradient-to-t from-blue-500 via-blue-400 to-red-500 transition-all duration-75" style={{ height: `${steamProgress}%` }}></div>
                                        <div className="absolute top-0 left-1 w-1.5 h-full bg-white opacity-30 rounded-full"></div>
                                        <div className="absolute right-0 top-[10%] w-1.5 h-px bg-gray-400"></div>
                                        <div className="absolute right-0 top-[30%] w-1.5 h-px bg-gray-400"></div>
                                        <div className="absolute right-0 top-[40%] w-1.5 h-px bg-gray-400"></div>
                                        <div className="absolute right-0 top-[50%] w-1.5 h-px bg-gray-400"></div>
                                        <div className="absolute right-0 top-[60%] w-1.5 h-px bg-gray-400"></div>
                                        <div className="absolute right-0 top-[70%] w-1.5 h-px bg-gray-400"></div>
                                        <div className="absolute right-0 top-[80%] w-1.5 h-px bg-gray-400"></div>
                                        <div className="absolute right-0 top-[90%] w-1.5 h-px bg-gray-400"></div>
                                  </div>
                               </div>
                               
                               <button 
                                 onMouseDown={handleStopSteam}
                                 onTouchStart={handleStopSteam}
                                 className="mt-8 bg-gradient-to-r from-red-600 to-red-500 text-white font-bold py-3 px-10 rounded-full text-lg shadow-[0_4px_0_#991b1b] active:shadow-none active:translate-y-1 transition-all"
                               >
                                 ç«‹å³å‡ºç‚‰!
                               </button>
                               <p className="mt-2 text-[10px] text-gray-500 font-bold">ç»¿è‰²åˆ»åº¦ç‚¹å‡»</p>
                            </div>
                          )}
                        </div>

                        {cookingStep === 'PREP' && (
                          <div className="bg-white p-2 pb-4 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-10 animate-in slide-in-from-bottom duration-500 shrink-0">
                            <h4 className="text-[10px] font-bold text-gray-400 mb-1.5 uppercase text-center">ç‚¹å‡»æ·»åŠ é£Ÿæ Ingredients</h4>
                            <div className="grid grid-cols-5 gap-2 px-1">
                              {INGREDIENTS_POOL.map((ing) => {
                                const isNeeded = currentOrder.ingredients.includes(ing.id);
                                const isAdded = worktable.includes(ing.id);
                                const isNextStepDough = worktable.length === 0 && ing.id === 'é¢å›¢';
                                const isNextStepIngredient = worktable.length > 0 && isNeeded && !isAdded;
                                const shouldHighlight = isNextStepDough || isNextStepIngredient;

                                return (
                                    <IngredientBtn 
                                        key={ing.id} 
                                        ing={ing} 
                                        onClick={handleIngredientClick} 
                                        shouldHighlight={shouldHighlight}
                                    />
                                )})}
                            </div>
                          </div>
                        )}
                      </div>
                  </>
              )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<BODGame />);
    </script>
</body>
</html>


